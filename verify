#!/bin/bash

ok=1
failures=""
count=0

run() {
    filename=$1
    echo "$filename:"
    basename=${filename%.*}
    suffix=${filename#*.}
    out=$filename.out
    case $suffix in
        adb)
            gnatmake $basename
            ./$basename > $out
            rm -f $basename{,.ali,.o}
            ;;
        bas)
            bwbasic $filename | sed '/ \|^$/d' > $out # Need to filter out the copyright header
            ;;
        c)
            gcc -std=c99 $filename -o $basename
            ./$basename > $out
            rm -f $basename
            ;;
        cpp)
            g++ $filename -o $basename
            ./$basename > $out
            rm -f $basename
            ;;
        cs)
            gmcs $filename
            ./$basename.exe > $out
            rm -f $basename.exe
            ;;
        f)
            gfortran $filename -o $basename
            ./$basename > $out
            rm -f $basename
            ;;
        go)
            go build -o $basename $filename
            ./$basename > $out
            rm -f $basename
            ;;
        java)
            javac $filename
            java $basename > $out
            ;;
        pas)
            fpc $filename
            ./$basename > $out
            rm -f $basename
            ;;
        *)
            ./$filename > $out
            ;;
    esac
    if ! cmp -s $out expected-output.txt ; then
        ok=0
        failures="$failures $name"
    fi
    rm -f $out
    (( count++ ))
}

run fizzbuzz.adb
run fizzbuzz.bas
run fizzbuzz.bash
run fizzbuzz.c
run fizzbuzz.cpp
run fizzbuzz.cs
run fizzbuzz.csh
run fizzbuzz.f
run fizzbuzz.go
run fizzbuzz.guile
run fizzbuzz.java
run fizzbuzz.js
run fizzbuzz.lua
run fizzbuzz.pas
run fizzbuzz.php
run fizzbuzz.pl
run fizzbuzz.pl6
run fizzbuzz.py
run fizzbuzz.rb
run fizzbuzz.sh

echo Tested $count languages
if [ $ok -eq 1 ] ; then
    echo OK
else
    echo Failures: $failures
fi
