#!/bin/bash

ok=1
failures=""
count=0

run() {
    name=$1
    if [ $# -eq 1 ] ; then
        echo "$name":
        if [ $name = *.java ] ; then
            javac $name
            java fizzbuzz
        elif [ $name = *.bas ] ; then
            bwbasic $name | sed '/ \|^$/d'  # Need to filter out the copyright header
        else
            ./$1
        fi > $name.out
    else
        shift
        echo "$name":
        if [ $name = *.cs ] ; then
            eval "$@" && ./fizzbuzz.exe > $name.out
        else
            eval "$@" && ./fizzbuzz > $name.out
        fi
    fi
    if ! cmp -s $name.out expected-output.txt ; then
        ok=0
        failures="$failures $name"
    fi
    rm -f $name.out fizzbuzz.class fizzbuzz fizzbuzz.o fizzbuzz.ali fizzbuzz.exe
    (( count++ ))
}

run fizzbuzz.adb     gnatmake fizzbuzz
run fizzbuzz.bas
run fizzbuzz.bash
run fizzbuzz.c       gcc -std=c99 fizzbuzz.c -o fizzbuzz
run fizzbuzz.cpp     g++ fizzbuzz.cpp -o fizzbuzz
run fizzbuzz.cs      gmcs fizzbuzz.cs
run fizzbuzz.csh
run fizzbuzz.f       gfortran fizzbuzz.f -o fizzbuzz
run fizzbuzz.go      go build -o fizzbuzz fizzbuzz.go
run fizzbuzz.guile
run fizzbuzz.java
run fizzbuzz.js
run fizzbuzz.lua
run fizzbuzz.pas     fpc fizzbuzz.pas
run fizzbuzz.php
run fizzbuzz.pl
run fizzbuzz.pl6
run fizzbuzz.py
run fizzbuzz.rb
run fizzbuzz.sh

echo Tested $count languages
if [ $ok -eq 1 ] ; then
    echo OK
else
    echo Failures: $failures
fi
