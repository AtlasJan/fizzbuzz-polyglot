#!/bin/bash

ok=true
failures=""
count=0
failure_count=0

run() {
    filename=$1
    echo "$filename:"
    basename=${filename%.*}
    suffix=${filename#*.}
    out=$filename.out
    tmpdir=${filename}__$$
    mkdir $tmpdir || return
    cd $tmpdir
    cp -p ../$filename ../expected-output.txt .
    case $suffix in
        a68)
            a68g $filename > $out
            ;;
        adb)
            gnatmake $basename
            ./$basename > $out
            ;;
        b)
            sed 's/^$/#include <stdio.h>/;s/main()/int main(void)/;s/auto/auto int/;s/*n/\\n/' $filename >| $filename.c
            gcc $filename.c -o $basename
            ./$basename > $out
            ;;
        bas)
            bwbasic $filename | sed '/ \|^$/d' > $out # Need to filter out the copyright header
            ;;
        c)
            gcc -std=c99 $filename -o $basename
            ./$basename > $out
            ;;
        cob)
            cobc -x $filename
            ./$basename > $out
            ;;
        cpp)
            g++ $filename -o $basename
            ./$basename > $out
            ;;
        cs)
            gmcs $filename
            ./$basename.exe > $out
            ;;
        curl)
            ./$filename > $out 2>/dev/null
            ;;
        d)
            gdc $filename -o $basename
            ./$basename > $out
            ;;
        f66)
            cp $filename fizzbuzz66.f
            fort77 -w66 -ext fizzbuzz66.f -o $basename
            ./$basename > $out
            ;;
        f)
            fort77 $filename -o $basename
            ./$basename > $out
            ;;
        f90)
            gfortran $filename -o $basename
            ./$basename > $out
            ;;
        fizzbuzz)
            /usr/local/bin/fizzbuzz $filename > $out
            ;;
        go)
            go build -o $basename $filename
            ./$basename > $out
            ;;
        gpt)
            gpt $filename -o $basename
            ./$basename > $out
            ;;
        groovy)
            groovyc $filename
            jar cvf $basename.jar *.class
            CLASSPATH=$basename.jar groovy $basename > $out
            ;;
        hs)
            ghc $filename
            ./$basename > $out
            ;;
        java)
            javac $filename
            jar cfe $basename.jar $basename $basename.class
            java -jar $basename.jar > $out
            ;;
        pas)
            fpc $filename
            ./$basename > $out
            ;;
        pure)
            # This LD_LIBRARY_PATH setting works for my system; YMMV.
            LD_LIBRARY_PATH=/usr/local/lib ./$filename > $out
            ;;
        m)
            . /usr/share/GNUstep/Makefiles/GNUstep.sh
            cc -std=c99 `gnustep-config --objc-flags` $filename -lobjc -lgnustep-base -o $basename
            ./$basename > $out
            ;;
        m4)
            m4 $filename > $out
            ;;
        mod)
            # Ugly hack ...
            ln -s /usr/lib/x86_64-linux-gnu/libmpc.so.3 libmpc.so.2
            LD_LIBRARY_PATH=. gm2 $filename -o $basename
            ./$basename > $out
            ;;
        nim)
            nim compile $filename
            ./$basename > $out
            ;;
        nodejs)
            if [ -x /usr/bin/nodejs ] ; then
                # Ubuntu 12.10
                ./$filename &
            elif [ -x /usr/bin/node ] ; then
                # Ubuntu 12.04
                /usr/bin/node $filename &
            fi
            sleep 1
            curl --silent http://localhost:9000 > $out
            kill $!
            ;;
        ratfor)
            ratfor -o $filename.f $filename
            f77 $filename.f -o $basename
            ./$basename > $out
            ;;
        rs)
            # This LD_LIBRARY_PATH setting works for my system; YMMV.
            LD_LIBRARY_PATH=/usr/local/lib rustc $filename
            ./$basename > $out
            ;;
        sx)
            gcc $filename -o $basename
            ./$basename > $out
            ;;
        scala)
            scalac $filename
            jar cfe $basename.jar $basename *.class
            scala $basename.jar > $out
            ;;
        tail)
            _POSIX2_VERSION=199209 ./$filename > $out
            ;;
        vala)
            valac $filename -o $basename
            ./$basename > $out
            ;;
        vb)
            vbnc $filename
            chmod +x $basename.exe
            ./$basename.exe > $out
            ;;
        vim)
            vim --cmd "source $filename"
            ;;
        ws)
            wspace $filename | egrep -v '^(Done|Stack size|Heap size)' > $out
            ;;
        *)
            ./$filename > $out
            ;;
    esac
    if ! cmp -s $out expected-output.txt ; then
        ok=false
        failures="$failures $filename"
        (( failure_count++ ))
    fi
    cd ..
    rm -rf $tmpdir
    (( count++ ))
}

if [ $# -gt 0 ] ; then
    for file in "$@" ; do
        run $file
    done
else
    for file in fizzbuzz.* ; do
        run $file
    done
fi

s=''
if [ $count -ne 1 ] ; then
    s=s
fi
echo Tested $count language$s
if $ok ; then
    echo OK
else
    s=s
    if [ $failure_count -eq 1 ] ; then s='' ; fi
    echo "$failure_count failure$s: $failures"
fi
